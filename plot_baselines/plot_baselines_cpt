#!/bin/bash

# Program for interferogram pair plotting
# Need two CPT files, a Single Master file for baselines obtain
# and the interferogram final selection. Use those files as arguments
# use as:
# plot_baselines_cpt SM.par INTF.par
# Those par files are generated by CPT and inside the 00_datafiles/dif folder.
# JoaquÃ­n Escayo @ jescayo@ucm.es April 2019.
# The GMT commands are extracted from GMTSAR routines, credits to Xiaohua(Eric) Xu.

datediff() {
    d1=$(date -d "20140102" +%s)
    d2=$(date -d "$1" +%s)
    echo $(( (d2 - d1) / 86400 ))
}

if [ ! -f $1 ] || [ ! -f $2 ]; then
	echo "Must especify a Single Master file and Interferogram file"
	echo "Run as: plot_baselines_ctp SM.par INTF.par"
	exit
fi


SM=$1
INTF=$2

# formateo de input file:
tail -n +2 $SM > tmp
awk 'NR==1 {print $1" "0}' tmp > tmp2
awk '{print $3" "$5}' tmp >> tmp2
mv tmp2 tmp
#awk '{print $0" SLC"NR}' tmp > tmp2 # Print SLCXX on labels
awk '{print $0" "NR}' tmp > tmp2 # Print XX on labels
mv tmp2 tmp

while read i; do
date=$(echo $i | awk '{print $1}')
baseline=$(echo $i | awk '{print $2}')
slc=$(echo $i | awk '{print $3}')
date_new=$(datediff $date)
date_new_final=$(echo $date_new | awk '{print 2014+$1/365.5}')
echo $date_new $baseline $slc $date $date_new_final >> tmp2
done < tmp

mv tmp2 tmp

# Print SLC points
awk '{print $5,$2,$3}' < tmp > text
region1=($(gmt gmtinfo text -C | awk '{print $1-0.5}'))
region2=($(gmt gmtinfo text -C | awk '{print $2+0.5}'))
region3=($(gmt gmtinfo text -C | awk '{print $3-50}'))
region4=($(gmt gmtinfo text -C | awk '{print $4+50}'))

gmt pstext text -JX8.8i/6.8i -R$region1/$region2/$region3/$region4 -D0.1/0.1 -X1.5i -Y1i -K -N -F+f10,Helvetica+j5 > baseline.ps

# Plot interferogram lines
tail -n +2 $INTF > tmp2
while read i; do
IMG1=$(echo $i | awk '{print $1}')
IMG2=$(echo $i | awk '{print $3}')
grep $IMG1 tmp | awk '{print $5" "$2}'> tmp3
grep $IMG2 tmp | awk '{print $5" "$2}'>> tmp3
gmt psxy tmp3 -Wred -R -J -K -O >> baseline.ps
done < tmp2

awk '{print $1,$2}' < text > text2
gmt psxy tmp3 -R -JX -B+t"Interferogram Selection" -Wred -K -O >> baseline.ps # Title
gmt psxy text2 -Sp0.2c -G0 -R -JX -Ba1f0.25:"year":/a150g00f50:"baseline (m)":WSen -O >> baseline.ps # Axis


#CLEANUP
rm text* tmp*

# Conversion to other formats
gmt psconvert baseline.ps -P -Tg -A -E250 # png format

gmt psconvert baseline.ps -P -Tf -A  # PDF format
